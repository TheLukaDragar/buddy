# ============================================================================
# Workout Session Queries and Mutations
# ============================================================================
# GraphQL queries and mutations for workout session tracking
# ============================================================================

# Query to get workout session by plan and date (for card completion status)
query GetWorkoutSessionByDate($workoutPlanId: UUID!, $date: Date!) {
  workout_sessionsCollection(
    filter: {
      workout_plan_id: { eq: $workoutPlanId }
      date: { eq: $date }
    }
    first: 1
    orderBy: [{ created_at: DescNullsLast }]
  ) {
    edges {
      node {
        id
        status
        completed_exercises
        completed_sets
        total_exercises
        total_sets
        total_time_ms
        is_fully_completed
        finished_early
      }
    }
  }
}

# Query to check if workout entries for a plan/date have preset_id (Train Now indicator)
query GetWorkoutEntriesPresetId($workoutPlanId: UUID!, $date: Date!) {
  workout_entriesCollection(
    filter: {
      workout_plan_id: { eq: $workoutPlanId }
      date: { eq: $date }
    }
    first: 1
  ) {
    edges {
      node {
        preset_id
      }
    }
  }
}

# Query to get user workout statistics (all completed sessions with sets)
query GetUserWorkoutStatistics($userId: UUID!) {
  workout_sessionsCollection(
    filter: {
      user_id: { eq: $userId }
      status: { in: ["completed", "finished_early"] }
    }
    orderBy: [{ completed_at: DescNullsLast }]
  ) {
    edges {
      node {
        id
        status
        completed_at
        completed_exercises
        completed_sets
        total_exercises
        total_sets
        total_time_ms
        is_fully_completed
        workout_session_setsCollection {
          edges {
            node {
              id
              actual_reps
              actual_weight
              is_completed
            }
          }
        }
      }
    }
  }
}

# Query to get a single workout session with all related data
query GetWorkoutSession($id: UUID!) {
  workout_sessionsCollection(filter: { id: { eq: $id } }) {
    edges {
      node {
        id
        user_id
        workout_plan_id
        week_number
        day
        day_name
        date
        status
        started_at
        completed_at
        paused_at
        resumed_at
        current_exercise_index
        current_set_index
        completed_exercises
        completed_sets
        total_exercises
        total_sets
        total_time_ms
        total_pause_time_ms
        last_activity_at
        is_fully_completed
        finished_early
        created_at
        updated_at
      }
    }
  }
}

# Query to get user's active workout session
query GetActiveWorkoutSession($userId: UUID!) {
  workout_sessionsCollection(
    filter: { 
      user_id: { eq: $userId }
      status: { in: ["selected", "preparing", "exercising", "paused"] }
    }
    orderBy: [{ started_at: DescNullsLast }]
    first: 1
  ) {
    edges {
      node {
        id
        workout_plan_id
        week_number
        day
        day_name
        date
        status
        started_at
        paused_at
        resumed_at
        current_exercise_index
        current_set_index
        completed_exercises
        completed_sets
        total_exercises
        total_sets
        total_time_ms
        total_pause_time_ms
        last_activity_at
        is_fully_completed
        finished_early
      }
    }
  }
}

# Query to get all sets for a workout session
query GetWorkoutSessionSets($sessionId: UUID!) {
  workout_session_setsCollection(
    filter: { session_id: { eq: $sessionId } }
    orderBy: [{ completed_at: AscNullsLast }]
  ) {
    edges {
      node {
        id
        session_id
        workout_entry_id
        exercise_id
        set_number
        target_reps
        target_weight
        target_time
        actual_reps
        actual_weight
        actual_time
        difficulty
        user_notes
        started_at
        completed_at
        is_completed
        skipped
        created_at
        workout_entries {
          preset_id
        }
      }
    }
  }
}

# Query to get all adjustments for a workout session
query GetWorkoutSessionAdjustments($sessionId: UUID!) {
  workout_session_adjustmentsCollection(
    filter: { session_id: { eq: $sessionId } }
    orderBy: [{ created_at: AscNullsLast }]
  ) {
    edges {
      node {
        id
        session_id
        type
        workout_entry_id
        exercise_id
        from_value
        to_value
        reason
        affected_set_numbers
        affects_future_sets
        created_at
        exercises {
          id
          name
        }
      }
    }
  }
}

# Query to get conversation IDs for a workout session
query GetWorkoutSessionChat($sessionId: UUID!) {
  workout_session_chatCollection(
    filter: { session_id: { eq: $sessionId } }
    orderBy: [{ timestamp: AscNullsLast }]
  ) {
    edges {
      node {
        id
        session_id
        conversation_id
        event_type
        details
        timestamp
        created_at
      }
    }
  }
}

# Mutation to create a new workout session
mutation CreateWorkoutSession(
  $userId: UUID!
  $workoutPlanId: UUID!
  $weekNumber: Int!
  $day: weekday!
  $dayName: String!
  $date: Date!
  $totalExercises: Int!
  $totalSets: Int!
) {
  insertIntoworkout_sessionsCollection(
    objects: [{
      user_id: $userId
      workout_plan_id: $workoutPlanId
      week_number: $weekNumber
      day: $day
      day_name: $dayName
      date: $date
      status: "selected"
      total_exercises: $totalExercises
      total_sets: $totalSets
    }]
  ) {
    records {
      id
      user_id
      workout_plan_id
      week_number
      day
      day_name
      date
      status
      started_at
      current_exercise_index
      current_set_index
      completed_exercises
      completed_sets
      total_exercises
      total_sets
      created_at
    }
    affectedCount
  }
}

# Mutation to update workout session status
mutation UpdateWorkoutSessionStatus(
  $id: UUID!
  $status: String!
  $lastActivityAt: Datetime
) {
  updateworkout_sessionsCollection(
    filter: { id: { eq: $id } }
    set: { 
      status: $status
      last_activity_at: $lastActivityAt
    }
  ) {
    records {
      id
      status
      updated_at
      last_activity_at
    }
    affectedCount
  }
}

# Mutation to update workout session progress
mutation UpdateWorkoutSessionProgress(
  $id: UUID!
  $currentExerciseIndex: Int
  $currentSetIndex: Int
  $completedExercises: Int
  $completedSets: Int
  $totalTimeMs: BigInt
  $totalPauseTimeMs: BigInt
  $lastActivityAt: Datetime
) {
  updateworkout_sessionsCollection(
    filter: { id: { eq: $id } }
    set: {
      current_exercise_index: $currentExerciseIndex
      current_set_index: $currentSetIndex
      completed_exercises: $completedExercises
      completed_sets: $completedSets
      total_time_ms: $totalTimeMs
      total_pause_time_ms: $totalPauseTimeMs
      last_activity_at: $lastActivityAt
    }
  ) {
    records {
      id
      current_exercise_index
      current_set_index
      completed_exercises
      completed_sets
      total_time_ms
      total_pause_time_ms
      last_activity_at
    }
    affectedCount
  }
}

# Mutation to update pause/resume timestamps
mutation UpdateWorkoutSessionPause(
  $id: UUID!
  $pausedAt: Datetime
  $resumedAt: Datetime
  $lastActivityAt: Datetime
) {
  updateworkout_sessionsCollection(
    filter: { id: { eq: $id } }
    set: {
      paused_at: $pausedAt
      resumed_at: $resumedAt
      last_activity_at: $lastActivityAt
    }
  ) {
    records {
      id
      paused_at
      resumed_at
    }
    affectedCount
  }
}

# Mutation to complete a workout set
mutation CompleteWorkoutSet(
  $sessionId: UUID!
  $workoutEntryId: UUID!
  $exerciseId: UUID!
  $setNumber: Int!
  $targetReps: Int
  $targetWeight: BigFloat
  $targetTime: Int
  $actualReps: Int
  $actualWeight: BigFloat
  $actualTime: Int
  $difficulty: String
  $userNotes: String
  $startedAt: Datetime
  $pauseTimeMs: BigInt
) {
  insertIntoworkout_session_setsCollection(
    objects: [{
      session_id: $sessionId
      workout_entry_id: $workoutEntryId
      exercise_id: $exerciseId
      set_number: $setNumber
      target_reps: $targetReps
      target_weight: $targetWeight
      target_time: $targetTime
      actual_reps: $actualReps
      actual_weight: $actualWeight
      actual_time: $actualTime
      difficulty: $difficulty
      user_notes: $userNotes
      started_at: $startedAt
      pause_time_ms: $pauseTimeMs
      is_completed: true
    }]
  ) {
    records {
      id
      session_id
      workout_entry_id
      exercise_id
      set_number
      actual_reps
      actual_weight
      actual_time
      started_at
      pause_time_ms
      difficulty
      completed_at
    }
    affectedCount
  }
}

# Mutation to update rest duration for a completed set
mutation UpdateSetRestDuration(
  $sessionId: UUID!
  $workoutEntryId: UUID!
  $setNumber: Int!
  $restStartedAt: Datetime!
  $restCompletedAt: Datetime!
  $restDurationSeconds: Int!
  $restExtended: Boolean!
) {
  updateworkout_session_setsCollection(
    filter: {
      session_id: { eq: $sessionId }
      workout_entry_id: { eq: $workoutEntryId }
      set_number: { eq: $setNumber }
    }
    set: {
      rest_started_at: $restStartedAt
      rest_completed_at: $restCompletedAt
      rest_duration_seconds: $restDurationSeconds
      rest_extended: $restExtended
    }
  ) {
    records {
      id
      session_id
      workout_entry_id
      set_number
      rest_started_at
      rest_completed_at
      rest_duration_seconds
      rest_extended
    }
    affectedCount
  }
}

# Mutation to add workout adjustment
mutation AddWorkoutAdjustment(
  $sessionId: UUID!
  $type: String!
  $workoutEntryId: UUID
  $exerciseId: UUID
  $fromValue: String!
  $toValue: String!
  $reason: String!
  $affectedSetNumbers: [Int!]
  $affectsFutureSets: Boolean
  $metadata: JSON
) {
  insertIntoworkout_session_adjustmentsCollection(
    objects: [{
      session_id: $sessionId
      type: $type
      workout_entry_id: $workoutEntryId
      exercise_id: $exerciseId
      from_value: $fromValue
      to_value: $toValue
      reason: $reason
      affected_set_numbers: $affectedSetNumbers
      affects_future_sets: $affectsFutureSets
      metadata: $metadata
    }]
  ) {
    records {
      id
      session_id
      type
      workout_entry_id
      exercise_id
      from_value
      to_value
      reason
      created_at
    }
    affectedCount
  }
}

# Mutation to track ElevenLabs conversation connection/disconnection
mutation TrackWorkoutConversation(
  $sessionId: UUID!
  $conversationId: String!
  $eventType: String!
  $details: String
) {
  insertIntoworkout_session_chatCollection(
    objects: [{
      session_id: $sessionId
      conversation_id: $conversationId
      event_type: $eventType
      details: $details
    }]
  ) {
    records {
      id
      session_id
      conversation_id
      event_type
      details
      timestamp
    }
    affectedCount
  }
}

# Query to get workout plan IDs for a user
# This is a helper query to get workout_plan_ids first, then we can filter entries
query GetUserWorkoutPlanIds($userId: UUID!) {
  workout_plansCollection(
    filter: {
      user_id: { eq: $userId }
    }
  ) {
    edges {
      node {
        id
        status
      }
    }
  }
}

# Query to get future workout entries for specific workout plans and exercise
# Returns workout entries that haven't been completed yet (date >= today)
# Note: Client should first call GetUserWorkoutPlanIds, then pass workout_plan_ids array here
query GetFutureWorkoutEntries(
  $workoutPlanIds: [UUID!]!
  $exerciseId: UUID!
  $today: Date!
) {
  workout_entriesCollection(
    filter: {
      workout_plan_id: { in: $workoutPlanIds }
      exercise_id: { eq: $exerciseId }
      date: { gte: $today }
    }
    orderBy: [{ date: AscNullsLast }]
  ) {
    edges {
      node {
        id
        workout_plan_id
        exercise_id
        date
        reps
        weight
        time
        sets
        is_adjusted
        adjustment_reason
      }
    }
  }
}

# Mutation to bulk update workout entries with adjusted values
# Updates all future workout entries for specific workout plans and exercise
# Note: Client should first call GetUserWorkoutPlanIds, then pass workout_plan_ids array here
mutation ApplyAdjustmentToFutureWorkouts(
  $workoutPlanIds: [UUID!]!
  $exerciseId: UUID!
  $today: Date!
  $reps: String
  $weight: String
  $time: String
  $adjustmentReason: String
) {
  updateworkout_entriesCollection(
    filter: {
      workout_plan_id: { in: $workoutPlanIds }
      exercise_id: { eq: $exerciseId }
      date: { gte: $today }
    }
    set: {
      reps: $reps
      weight: $weight
      time: $time
      is_adjusted: true
      adjustment_reason: $adjustmentReason
    }
  ) {
    records {
      id
      exercise_id
      date
      reps
      weight
      time
      is_adjusted
      adjustment_reason
    }
    affectedCount
  }
}

# Mutation to complete workout session
mutation CompleteWorkoutSession(
  $id: UUID!
  $status: String!
  $completedAt: Datetime!
  $isFullyCompleted: Boolean!
  $finishedEarly: Boolean!
  $completedExercises: Int
  $completedSets: Int
  $totalTimeMs: BigInt
  $totalPauseTimeMs: BigInt
) {
  updateworkout_sessionsCollection(
    filter: { id: { eq: $id } }
    set: {
      status: $status
      completed_at: $completedAt
      is_fully_completed: $isFullyCompleted
      finished_early: $finishedEarly
      completed_exercises: $completedExercises
      completed_sets: $completedSets
      total_time_ms: $totalTimeMs
      total_pause_time_ms: $totalPauseTimeMs
    }
  ) {
    records {
      id
      status
      completed_at
      is_fully_completed
      finished_early
      completed_exercises
      completed_sets
      total_time_ms
      total_pause_time_ms
    }
    affectedCount
  }
}

